<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: contrib/upload/server/controllers/meanUpload.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: contrib/upload/server/controllers/meanUpload.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var fs = require('fs'),
config = require('meanio').loadConfig(),
mkdirOrig = fs.mkdir,
directory = config.root + '/',
osSep = '/';

/**
 * Changes the name of an existing file
 *
 * @param file - the file to be renamed
 * @param dest - where the file is located
 * @param user - the admin who created the file 
 * @param callback - the path to callback the file
 */

function rename(file, dest, user, callback) {
    fs.rename(file.path, directory + file.name, function(err) {
        if (err) throw err;
        else
            callback({
                success: true,
                file: {
                    src: '/'+file.name,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    created: Date.now(),
                    createor: (user) ? {
                        id: user.id,
                        name: user.name
                    } : {}
                }
            });
    });
}

/**
 * Make a new directory
 *
 * @param path- the path where the folder will be created
 * @param position - the location of folder
 * @param callback - the path to callback 
 */

function mkdir_p(path, callback, position) {
    var parts = require('path').normalize(path).split(osSep);

    position = position || 0;

    if (position >= parts.length) {
        return callback();
    }

    var directory = parts.slice(0, position + 1).join(osSep) || osSep;
    fs.stat(directory, function(err) {
        if (err === null) {
            mkdir_p(path, callback, position + 1);
        } else {
            mkdirOrig(directory, function(err) {
                if (err &amp;&amp; err.code !== 'EEXIST') {
                    return callback(err);
                } else {
                    mkdir_p(path, callback, position + 1);
                }
            });
        }
    });
}

/**
 * Publish a new file event to the project's display
 *
 * @param MeanUpload - the service used to publish a file through mean
 * @param user - the admin who created the file 
 * @param data - the actual dataz of the file
 */

function publishEvent(MeanUpload, user, data) {
    if (config.hostname &amp;&amp; data.success)
       MeanUpload.events.publish({
        action: 'uploaded',
        user: {
            name: user
        },
        name: data.file.name,
        url: config.hostname + data.file.src,
        data: {
         size: data.file.size,
         type: data.file.type,
         url: config.hostname + data.file.src,
         file_name: data.file.name
     }
 });
}

module.exports = function(MeanUpload) {
    return  {
        upload: function(req, res) {
            var path = directory + req.body.dest;
            if (!fs.existsSync(path)) {
                mkdir_p(path, function(err) {
                    rename(req.files.file, req.body.dest, req.user, function(data) {
                        publishEvent(MeanUpload, req.user.name, data);
                        res.jsonp(data);
                    });
                });
            } else {
                rename(req.files.file, req.body.dest, req.user, function(data) {
                    publishEvent(MeanUpload, req.user.name, data);
                    res.jsonp(data);
                });
            }
        }
    }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#all">all</a></li><li><a href="global.html#article">article</a></li><li><a href="global.html#authCallback">authCallback</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#ExpertiseGraph">ExpertiseGraph</a></li><li><a href="global.html#forgotpassword">forgotpassword</a></li><li><a href="global.html#me">me</a></li><li><a href="global.html#mkdir_p">mkdir_p</a></li><li><a href="global.html#mongoose">mongoose</a></li><li><a href="global.html#publishEvent">publishEvent</a></li><li><a href="global.html#rename">rename</a></li><li><a href="global.html#resetpassword">resetpassword</a></li><li><a href="global.html#sendMail">sendMail</a></li><li><a href="global.html#session">session</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#signin">signin</a></li><li><a href="global.html#signout">signout</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#user">user</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Mar 31 2016 17:12:55 GMT-0600 (MDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
